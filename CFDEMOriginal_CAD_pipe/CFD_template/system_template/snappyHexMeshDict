// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //
/*--------------------------------*- C++ -*----------------------------------*\
| =========                 |                                                 |
| \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox           |
|  \\    /   O peration     | Version:  2.0                                   |
|   \\  /    A nd           | Web:      http://www.OpenFOAM.org               |
|    \\/     M anipulation  |                                                 |
\*---------------------------------------------------------------------------*/
FoamFile
{
version  2.0;
format   ascii;
class       dictionary;
object      snappyHexMeshDict;
}


//**************************************************************************************************************************

// Which of the steps to run
castellatedMesh true;
snap            true;
addLayers       true;

//**************************************************************************************************************************



//**************************************************************************************************************************

geometry
{

    my_stlSurface
    {
        type triSurfaceMesh;
        file "surfacemesh.stl";

        regions
        {
                    inlet              	// Named region in the STL file                     
            {
                name inlet;      	// User-defined patch name - Can be the same as in the STL (Recommended)
            }                               

            outlet {name outlet;} 
            pipewall {name pipewall;} 
        }
    }

    // refinementBox
    // {
    //     type searchableBox;
    //     min (-0.03 -0.03 0.9);
    //     max (0.03 0.03 1.3);
    // }

};

//**************************************************************************************************************************



//**************************************************************************************************************************

// Settings for the castellatedMesh generation.
castellatedMeshControls
{

    // Refinement parameters

    maxLocalCells       100000;
    maxGlobalCells      2000000;
    minRefinementCells  1; //0-10
    maxLoadUnbalance    0.10;
    nCellsBetweenLevels 3;

    planarAngle         30;
    allowFreeStandingZoneFaces true;

    // Feature angle
    resolveFeatureAngle 30;         //recommended
    //resolveFeatureAngle 60;       //To avoid too much refinement with curvature   


    // Explicit feature edge refinement
    features
    (
        {
            file "surfacemesh.eMesh";
            level 1;
        }
    );

      // Surface based refinement
    refinementSurfaces
    {
        my_stlSurface
        {
            level (1 1);
            //level (2 4);  //second value add more refinement where there is more curvature 

            // Optional region-wise level specification
            regions
            {
                inlet          // Named region in the STL file
                {
                    level (1 1);
                    patchInfo{ type wall; } 
                }

                outlet          // Named region in the STL file
                {
                    level (1 1);
                    patchInfo {type wall;} 
                }

                pipewall          // Named region in the STL file
                {
                    level (1 2);
                    patchInfo {type wall;} 
                }
            }

        }
    }


    // Region-wise refinement
    refinementRegions
    {
    }



    // Mesh selection
    locationInMesh (0.0 0.0 0.1); 

}

//**************************************************************************************************************************



//**************************************************************************************************************************

// Settings for the snapping.
snapControls
{

    nSmoothPatch 3;	//recommended
    //nSmoothPatch 10;	//improved

    tolerance 2.0;
    //tolerance 1.0;

    nSolveIter 50;	//recommended
    //nSolveIter 100;	//improved

    nRelaxIter 5;	//recommended
    //nRelaxIter 10;	//improved	10-20-50

    // Feature snapping
    nFeatureSnapIter 10;	//recommended
    //nFeatureSnapIter 100;	//improved	20-50-100

    implicitFeatureSnap false;

    explicitFeatureSnap true;

     multiRegionFeatureSnap false;

}

//**************************************************************************************************************************



//**************************************************************************************************************************

// Settings for the layer addition.
addLayersControls
{

    layers
    {

        "(pipewall)"      //User-defined patch name 
        {
            nSurfaceLayers 3;
        }

    }

    relativeSizes true;

    // Layer thickness specification. This can be specified in one of following
    // ways:
    //first layer thickness ('firstLayerThickness') and overall thickness ('thickness') or
    //first layer thickness ('firstLayerThickness') and expansion ratio ('expansionRatio') or
    //final layer thickness ('finalLayerThickness') and expansion ratio ('expansionRatio') or
    //final layer thickness ('finalLayerThickness') and overall thickness ('thickness') or
    //overall thickness ('thickness') and expansion ratio ('expansionRatio'

    //expansionRatio 1.0;
    expansionRatio 1.2;
    //finalLayerThickness 0.5;
    firstLayerThickness 0.1;
    //thickness 0.5
    minThickness 0.1;


    //BL Advanced settings - Quality parameters - A game of numbers

    nGrow 0;

    //featureAngle              0;		    //no inflation
    featureAngle                130;		//recommended
    //featureAngle              330;		//improved

    slipFeatureAngle            30;     //15

    nSmoothSurfaceNormals       1;
    nSmoothNormals              3;
    nSmoothThickness            10;
    maxFaceThicknessRatio       0.5;
    maxThicknessToMedialRatio   0.6;    //0.3

    minMedialAxisAngle          90;
    nMedialAxisIter             10;

    nBufferCellsNoExtrude       0;

    additionalReporting       false;
    //nSmoothDisplacement       0;
    //detectExtrusionIsland     false;

    nLayerIter                  50;
    nRelaxedIter                20;
    nRelaxIter                  5;

}

//**************************************************************************************************************************



//**************************************************************************************************************************

// Generic mesh quality settings. At any undoable phase these determine where to undo.
meshQualityControls
{
    #include "meshQualityDict"


    // Advanced - Can be commented

    // Number of error distribution iterations
    nSmoothScale 4;
    
    // amount to scale back displacement at error points
    errorReduction 0.75;

    relaxed
    {
        // Maximum non-orthogonality allowed. Set to 180 to disable.
        maxNonOrtho 75;
    }

}

//**************************************************************************************************************************



//**************************************************************************************************************************

// Extra options - Optional

debugFlags
(
    //mesh            // write intermediate meshes
    //intersections   // write current mesh intersections as .obj files
    //featureSeeds    // write information about explicit feature edge
                    // refinement
    //attraction      // write attraction as .obj files
    //layerInfo       // write information about layers
);

//**************************************************************************************************************************



//**************************************************************************************************************************

writeFlags
(
    scalarLevels    // write volScalarField with cellLevel for postprocessing
    layerSets       // write cellSets, faceSets of faces in layer
    layerFields     // write volScalarField for layer coverage
);

//**************************************************************************************************************************



mergeTolerance 1e-6;


// ************************************************************************* //
